[TOC]

## 第 1 章 初识Redis

> 五种类型的基本使用方法，加一个投票小案例

一般使用:作为分隔符，也可用./|，保持统一

## 第 2 章 使用Redis构建Web应用

### 登录和cookie缓存

使用hash(散列)保存用户信息

有序集合或列表保存用户访问记录，最多保存1000万个(假设)(或每个用户保存一个月内的10000个)，如果超出，每次删除最老的100个，如果没有达到最大值，休眠1秒再次计数

### 使用Redis实现购物车

每个购物车都是一个hash，保存商品id和数量之间的映射。如果商品数量大于0，添加到hash中，如果hash中已有则覆盖，如果不大于0就从hash中删除

### 数据行缓存

> 对数据的某些字段进行不定期更新缓存

例如促销活动，将需要频繁查询修改的n个字段放一起 toJSON 保存到redis中

（将整个活动每个字段缓存到redis hash中，但是对于标题等字段不需要更新，只需要不定期更新库存等字段即可）

使用两个有序集合来记录应该在何时更新缓存

1. 调度有序集合：key为字段名，值为时间戳，记录应该在何时缓存数据
2. 延时有序集合：key为字段名，值为缓存应该多久更新一次

程序先每50ms循环从集合1中查询是否有需要缓存的数据，如果有，开始缓存数据，并将集合1的时间设置为当前时间+集合2的延迟时间。

可修改2的时间，当为0时删除两个集合对应数据，不再进行更新

（可能会导致超卖）

### 网页分析

> 找出热门数据对它们进行缓存，而非缓存所有

通过每个用户访问记录的有序集合来计算热门数据太耗时间

需要一个记录所有商品浏览次数的有序集合viewed:userid，对浏览次数进行排序，浏览最多的商品放在索引0的位置（？），且具有序集合最少的分值(scope)

```python
redis.add("viewed:" + userid, data, timestamp)
redis.zremrangebyrank('viewed' + userid, 0, -26) // 删除用户25名之后的浏览
redis.zincrby('viewed:', data, -1) // 减1分?
```

需要定期对排行榜数据进行更新，删除排名中多余的商品，并将剩余商品的浏览次数减半

zinterstore将一个或多个有序集合求并集并计算，生成一个新的集合

```python
redis.zremrangebyrank("viewed:", 0, -20001) // 删除2000名之后的商品
redis.zinterstore("viewed:", {'viewed': .5}) // 将浏览次数降低为原来的一半，给新商品流行的机会
```

最终可将前10000个商品进行缓存

## 第 3 章 Redis命令

### 字符串

字符串可保存字节串，整数（长整数），浮点数（双精度）。

数字可自增和自减，空串自增自减当做0处理，无法被解释为数字会报错

### 列表

列表可包含多个字符串值，使用户可以将数据集中在一个地方

列表相比集合省内存，因为不需要分值

### 集合

主要是保存不相同的元素，厉害在于组合和关联多个集合

### 散列(Hash)

多个键值对储存在redis key里，存储着键和值之间的映射，提供了一些与字符串相同的特性

### 有序集合

存储着成员和分值之间的映射，提供了分值（双精度浮点数）处理命令，可根据分值大小有序地获取或扫描成员和分值。交集和并集可实现搜索系统

### 发布与订阅 pub/sub

订阅者listener订阅频道channel，发布者publisher发送二进制字符串消息binary string message，订阅者会接收到消息

一般不使用redis的该模式

1. 旧版本redis，如果客户端读取消息的速度不够快，积压的消息会使redis输出缓冲区的体积越来越大，导致redis速度变慢，甚至崩溃，或者被系统杀死，甚至导致操作系统不可用。新版redis不存在这种问题，会自动断开不符合client-output-buffer-limit pubsub配置选项要求的订阅客户端
2. 传输可靠性，如果客户端在执行订阅中短线，那么客户端将在丢失断线期间发送的所有消息

### 其他命令

排序sort，用于列表、集合、有序集合的排序，默认升序

```
// 排序。返回或者存储结果
SORT key [BY xxx] [LIMIT offset count] [GET xxx [GET xxx ...]] [ASC|DESC] [ALPHA] [STORE key2]
```

### 基本的redis事务

watch、multi、exec、unwatch

PDF  页

书  页