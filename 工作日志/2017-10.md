## 10.11
#### -10.43
编辑圈子项目的可选项目使用api返回的数据，数据未加载出来时显示菊花，优化变量名，优化网络请求错误处理
圈子项目、圈子类别、活动项目、活动类别加载过一次后，缓存在store中，再次进入可以直接显示，不需要再加载
#### - 11.10
* 解决删除今日签到到无法再签到的bug：如果是自己的签到，就重新获取圈子信息，更新signed
* 解决签到列表如果数据不满屏，菊花有时不消失的bug，是因为onEndReachedThreshold小于菊花高度，没有触发onEndReached，同时把所有其他的ListView的onEndReachedThreshold设置为50
* 签到列表的图片加入backgroundColor，作为加载中时占位

#### -11.34
解决搜索圈子图片刷新不及时的问题。
> bug产生的原因：iOS的Image更换uri不会马上清空显示的内容，而是加载成功后才替换，所以在加载过程中依然显示旧图片。
> 解决：
> 1. 从Image加载的角度不好解决，所以要让Image重新创建，就要从ListView下手，而ListView更新已存在的row只是刷新，不是重新创建
> 2. react为组件提供了key属性，用于同级别的组件根据key的不同来优化渲染，原理就是如果key相同就刷新，key不同就重新创建
> 3. 在ListView的renderRow的最外层component添加key属性，设置为当然数据的唯一id，就可以在更新时重新创建Image，（不可以设置为row的索引，没有任何对优化的帮助而且会造成不可预料的问题）
> 4. 进一步优化，重新创建item会造成多余的开销，而现在只需要更新Image，所以renderRow的component去掉key属性，给Image添加key属性，设置为url，解决。

为了方便调试，可以删除RN图片缓存，位置：.../Library/Caches/com.luxiaoquan.www/fsCachedData

圈子列表也同时优化

#### -13.54
话题编辑使用以上方法依然不能解决闪烁的问题
话题列表图片添加占位背景图


## 10.11
#### -11.40
* android、iOS支付回调统一。ping++的回调resultCode字符串是统一的，但是errorMessage不同意，在桥接时分别处理

#### -16.55
支付后返回app的回调处理，同时要兼容其他回调。支付宝可以回调成功，微信无法返回APP，可能是支付的订单通过ping++的demo提供的url产生的，无法正确返回到鹿小圈APP。

一、在UShareManager.m中实现单例。之前通过监听RCTOpenURLNotification无法在分享微信小程序后正确回调，不走回调方法。需要统一在AppDelegate中处理，

```
static UShareManager *instance = nil;
+ (instancetype)sharedInstance {
  static dispatch_once_t onceToken;
  dispatch_once(&onceToken, ^{
    if(!instance) {
      instance = [[UShareManager alloc] init];
    }
  });
  return instance;
}
- (instancetype)init {
  self = [super init];
  if (self) {
    instance = self;
    [WXApi registerApp:@"wxc37d1663691dc2f0"];
  }
  return self;
}
```

二、在UShareManger.m中实现微信原生分享的回调。

```
- (BOOL)handleOpenURL:(NSURL *)url {
  return [WXApi handleOpenURL:url delegate:self];
}
```

早UShareMnager.h中暴露两个方法

```
+ (instancetype)sharedInstance;
- (BOOL)handleOpenURL:(NSURL *)url;
```

三、在AppDelegate中通过`-application: openURL: sourceApplication: annotation:`方法处理通过其他app返回的回调信息，这个openURL方法支持所有iOS版本。以现有的功能不需要实现handleOpenURL

```
- (BOOL)application:(UIApplication *)application openURL:(NSURL *)url
  sourceApplication:(NSString *)sourceApplication annotation:(id)annotation {
  BOOL canHandle = false;
  NSString *urlStr = [url absoluteString];
  if ([urlStr hasPrefix:@"wxc37d1663691dc2f0://oauth"]) {
    // 微信登陆
    canHandle = [RCTLinkingManager application:application openURL:url sourceApplication:sourceApplication annotation:annotation];
  }
  
  // canHandle = [[UMSocialManager defaultManager] handleOpenURL:url]; // 在下一步去掉
  canHandle = [[UShareManager sharedInstance] handleOpenURL:url]; // 在UShareManager中处理
  canHandle = [Pingpp handleOpenURL:url sourceApplication:sourceApplication withCompletion:nil];
  canHandle = [RCTLinkingManager application:application openURL:url sourceApplication:sourceApplication annotation:annotation];
  return canHandle;
}
```

四、分享微信小程序可以成功回调了，但是分享到朋友圈又回调失败了。调整代码顺序后，朋友圈成功，小程序失败，才明白openURL中也会存在冲突的问题，分享小程序是使用微信原生分享，分享到朋友圈是使用友盟分享。这两种情况的回调url都是`wxc37d1663691dc2f0://platformId=wechat`，所以需要在代码中区分（微信支付还无法回调，所以不确定微信支付的回调URL是什么）

```
@property (assign, nonatomic) BOOL isLastShareToMiniApp; // 用于openURL回调冲突

// 修改handleOpenURL方法
- (BOOL)handleOpenURL:(NSURL *)url {
  if (_isLastShareToMiniApp) {
    return [WXApi handleOpenURL:url delegate:self]; 
  } else {
    return [[UMSocialManager defaultManager] handleOpenURL:url];
  }
}
```

#### 18.36
搜索圈子页面搜索中不显示等待的GIF，显示“搜索中...”文字
搜索圈子更新图片未解决，RN iOS图片加载中不会消失，暂时没找到办法清空图片。把ListView替换为ScrollView应该可以解决，但是不是好办法，将来无法做搜索分页

## -10.10
#### -17.20
安卓支付集成

1. 按照[pingpp-react-native](https://coding.net/u/pingplusplus/p/pingpp-react-native)的文档，需要使用AndroidStudio手动导入node_modules/pingpp-react-native/android，命名为pingpp-react-native，会和原本的微信lib冲突。

    删除代码：pingpp-react-native/build.gradle：
`compile 'com.pingxx:pingpp-wxpay:2.1.9' //使用微信支付时添加`

    运行成功，微信支付时报错`                                                               java.lang.RuntimeException: Unable to start activity ComponentInfo{com.luxiaoquan.www/com.pingplusplus.react.PingppActivity}: java.lang.NullPointerException: Attempt to read from field 'android.content.pm.ApplicationInfo android.content.pm.ComponentInfo.applicationInfo' on a null object reference
`，支付宝没问题，认为可能是pingpp-rn的错误。
2. 下载最新的libs自己桥接android端ping++，不使用pingpp-rn，运行成功，依然报上面的错，看ping++文档，是因为没注册微信支付的activity，（不过之前pingpp-rn添加过了依然有错很奇怪）。准备继续使用自己桥接的ping++，因为自己定制，没有加入用不到的支付途径，包体积减少了1.5m。
3. 使用CocoPods自己桥接iOS端ping++，去掉了用不到的支付途径，减少了包体积，而且pingpp-rn调用支付没有在主线程执行UI。
4. 统一支付和debug模式的方法名和参数

- 18.40
开会

