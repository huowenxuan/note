## 11.7
#### -16.29
版本更新功能完成，少API

 * 如果是最新版，就不提示
 * 如果最新版本未提示过，就提示
 * 如果最新版本提示过，如果上次点了更新（但是没有更新），就提示
 * 如果最新版本提示过，上次点了关闭，距离上次提示的时间少于10天就不提示，大于10天就提示

> 点击升级或者关闭后，在本地保存提示日期、提示版本、是否点击了升级，在显示前根据这些来判断是否要提示升级

--
**针对TabPage多次reset会导致多次初始化，为了保证某些操作不重复执行，在class外立全局flag=true记录是第一次mount，在willMount中如果用户已登录以及进入圈子才会设置为false**

#### -18.20
在app本地保存安装时间，也就是第一次打开的时间

评分功能完成一部分，思考规则

```js
/**
 * 到达埋点后，是否去评分
 * 安装时间少于5天，不评分
 * 安装时间大于5天：
 *    如果有新版本，就去评分
 *    没有新版本：
 *       如果上次评分过，20天内不评分
 *       如果上次没评分过，10天内不评分
 */
```


## 11.6
针对两个新问题与一个老问题：

* 华为荣耀在登录成功后闪退，其他用过的手机没问题。是因为菊花的lightBox在RNN的startSingleScreenApp后没销毁而闪退
* android设置固定竖屏需要在willMount时设置才管用，而使用startSingleScreenApp就需要在登录、圈子列表、tab页中都添加相关代码，而在subscribe触发时候开销太大
* 启动图也要在willMount中消失

都是因为采用了RNN的startSingleScreenApp/startTabBaseApp来实现切换登录、圈子列表、tab页面，每次切换都修改了MainActivity的正常运行。之前一直在用RNN的tab必须要使用这种方法启动tab页，后来使用了新的tab，就不需要使用RNN来管理了，并且新tab使用懒加载，未登录时就不用管其他页面的api调用， 只要控制话题首页不调用就可以了。

直接使用startSingleScreenApp启动一个tab页
①登录->圈子列表->tab的流程通过resetTo来切换
②圈子列表->登录与tab->登录：iOS使用modal，android使用reset，如果使用modal，会响应返回键以及无法设置屏幕旋转，而且android上reset和modal的动画是一样的

好处：

1. 避免上面的bug

2. 可以在tabpage生命周期中执行操作，但并非只执行一次，因为**resetTo后会重新执行组件生命周期**
    >如果想执行一次（比如deeplink），只能在index中执行，依然是因为使用了RNN的原因，必须用rnn初始化app，而不是像普通方法使用组件来初始化，为了性能只能舍弃一点灵活性。
    
3. 切换过程有了动画，不用像以前一样生硬的跳转。而且进入app直接就是tab页，不像以前有明显的跳转痕迹

退出圈子和加入圈子加入菊花动画，**菊花是用lightBox而不是modal**

RNN不能存在两个lightBox的情况，需要延迟400ms才能再显示一个，但是没有考虑在第二次显示box，在400ms内就dismiss的情况。

## 11.3
#### -9.58
测试小米推送，关闭app后依然可以接收到推送。

关于网页推送的`点击后续动作`选项
由客户端自由定义：如果app在运行，会执行app定义的后续动作，如果不在运行，点击后根本不会打开app
打开应用：如果app在运行，不会执行定义的后续动作，如果不在执行，只会打开app

而且网页中的`点击后续动作`要设置为`打开应用`
> 小米上如果是第一次安装，修改完ip后需要再运行一次才能刷新代码。

#### -11.45
小米推送遇到些问题。如果app正在运行，可以通过监听clickMessage事件来获取到推送内容，但是如果app不在运行，需要在MainActivity的onCreate通过intent才能获取到通过点击推送通知打开app的推送内容。

想了半天，计划在MainActivity中获取到推送内容，在PushModule的一个单例类中保存初始推送内容，不使用通知了，JS端主动调用来获取到这个推送
#### -15.43
按照计划的方法。小米推送获取到初始推送完成。
>封装了Java的mapToReadableMap的方法。JS调用Java获取数据必须使用Promise，不能直接用返回值，是
异步操作。

#### -16.21
逛华为论坛。华为推送无法设置tag，不能区分用户，剩下的推送相关的工作需要后台配合才能往下做。

荣耀手机获取brand得到HONOR，不是华为

#### -18.45
修复bug
1. 发布页面分享。圈子名显示undefined，圈子图片为图标。少传了一个参数，惭愧
2. 图片滑动编辑页。禁止返回手势。disabledBackGesture: true不管用，需要在iOS自定义leftButtons才管用
3. 图片滑动页面，放大图片的显示。通过减去导航栏、完成按钮、输入框的高度获得图片高度，因为上面包含了区域ScrollView，必须设置固定高度，不能简单的通过flex=1来设置

## 11.2
#### -10.43
未找微信登录失败的原因。把登录失败的错误信息和错误码直接显示到屏幕上，帮助定位错误

发现一个问题，新用户登录进来时会显示加入的列表为空，是因为后台在圈子为空时返回的code返回3101，正常情况下返回3100。

#### -13.37
iOS推送的开发环境和生产环境证书配置完成，同时配置极光推送

#### -17.21
iOS推送集成极光推送，jpush-react-native，并且能够获取到推送的附加字段。

> **在控制台推送时附加字段键值都不能有空格**，否则推送目标就是0
> 接收到推送以及点击推送都没反应。要开启控制台的`content-available`字段
> 修改后可以在iOS端获取到，但是无法在JS获取到，issue和demo的事件名都写错了，应该是`openNotification`而不是`OpenNotification`

获取附加字段：
iOS推送得到的数据大概为：

```
{ 
  key1: 'value1',
  key2: 'value2',
  _j_msgid: 1682335528,
  _j_uid: 6161212335,
  _j_business: 1,
  aps: { 
    'content-available': 1,
     badge: 1,
     sound: 'default',
     alert: { title: '???', subtitle: 'pppp', body: 'gvvggv' } 
  }
}
```

key/value和小米一样可以随意赋值，除了自己设置的key1、key2之外，和小米一样还带了其他没用的字段，而aps里面是显示给用户的信息以及推送的设置（badge数量、声音、是否静默推送，都可以在发送推送时配置）

#### -18.51
测试安卓推送情况
小米手机：需要sim卡才能使用usb安装apk，明天测
华为手机：使用华为推送后，如果华为移动服务的版本很旧，会提示安装华为移动服务。如果不安装，在退出app后依然可以收到推送，只不过是使用老版本的华为推送服务（因为没设置app图标的话，华为移动服务的推送显示图标是华为，老推送的图标是安卓app缺省图标，在app设置图标就好了）。**不能调用setTags方法，会导致崩溃**

## 11.1
#### -10.44
android端点击推送消息，发送通知到JS
#### -14.07
集成华为推送
#### -18.20
接收与点击华为推送的消息
在其他手机上会提示安装华为移动服务，所以绝对不能在其他手机上连接华为推送。

安装完成后，还需要打开华为移动服务的所有权限。通过keytool获取到SHA256指纹证书后填入到华为开放平台，等10分钟左右生效。

和小米的配置方式不同，小米使用方法调用来初始化服务，华为需要在manifest中配置，所以要在主app的manifest中配置，而不能在module中

```
<meta-data
    android:name="com.huawei.hms.client.appid"
    android:value="100122645" />
```

华为的sdk和文档都写的很垃圾，文档甚至都没有设置tags的方法，
sdk必须在connect成功后才可以启动推送，也就是必须在在onConnected回调中才能申请token来启动Push服务`HuaweiPush.HuaweiPushApi.getToken(hwClient)`。运行后弹出华为使用协议就表示成功了

在网页中测试发送推送也不能发送给所有人，只能通过IMEI或标签

点击推送的消息后，将发来的消息转换为HashMap。华为的数据有点奇葩，用Java转换费了番功夫

```java
// 华为推送的extras结构：
"[{"key1: "value1"}, {"key2: value2"}]"
// 小米推送的extras结构：
{"key1": "value1", "key2": "value2"}
```

通过HuaweiPush.HuaweiPushApi.setTags来设置tag，但是传入的类型是map，和小米不同，小米是设置字符串类型的alias。但是设置后不生效。

官方文档原文：
注意：切换到HMS Push后，原来的setTag/getTag/deleteTag功能暂时不可用，老版本push sdk现在也无法上报新增标签，目前在华为开发者联盟portal上面仅支持根据存量的标签推送消息。HMS SDK会在后续版本实现该功能。  
垃圾          

