# 大型网站架构技术 核心原理与案例分析
[TOC]

13年出版，较老

## 序
网站架构其实并不难，真正能解决问题的技术一定是简单的

## 1 大型网站架构演化

大型互联网应用系统的特点：
- 高并发，大流量
- 高可用：不间断服务，不宕机
- 海量数据
- 用户分布广泛，网络情况复杂
- 安全环境恶劣
- 需求快速变更，发布频繁
- 渐进式发展

### 大型网站架构演化发展历程
1. 初始：应用程序、数据库、文件都保存在一台服务器
2. 应用服务和数据服务分离：应用服务器（需要更快更强大的CPU）、文件服务器（需要更大的硬盘）、数据库服务器（需要更快的硬盘和更大的内存）。数据库称为性能的瓶颈。
3. 使用缓存改善性能：大部分的业务集中在一小部分数据上，将这一小部分数据缓存在内存中，减少数据库压力。缓存分为两种：1）本地缓存的速度更快，但是数据量有限，而且会和应用程序争内存。2）远程分布式缓存可使用集群的方式，部署在大内存的服务器上。此时数据库访问压力得到缓解，但是单一应用服务器能处理的请求连接有限，在访问高峰期，应用服务器成为网站的瓶颈
4. 使用应用服务器集群改善网站的并发处理能力：使用集群解决高并发、海量数据问题。当一台服务器存储空间不足时，不要去换更强大的服务器，不管多么强大的服务器，都满足不了持续增长的业务，应该增加一台服务器分担原有服务器的访问及存储压力。
    持续增加服务器改善性能，实现系统的可伸缩性。应用服务器实现集群是网站可伸缩集群架构设计中较为简单成熟的一种。通过负载均衡调度服务器，可将用户的访问请求分发到应用服务器集群中的任何一台服务器上
5. 发数据库读写分离：数据库经过读写分离后拆分成两台服务器。大部分服务器支持主从热备功能，通过配置两台数据库主从关系，可将一台数据库服务器的数据同步到另一台，可实现数据库读写分离，改善负载压力
    在写数据时，访问主数据库，主数据库通过主从复制机制将数据更新同步到从数据库，当读取数据时，可通过从数据库获得数据。为了便于应用程序访问读写分离后的数据库，通常在应用服务器端使用专门的数据访问模块，使数据库读写分离对应用透明
6. 使用反向代理和CDN加速网站响应：由于中国复杂的网络环境，不同地区的用户访问网站时速度差别也很大。他们的基本原理都是缓存，CDN部署在网络提供商的机房，请求数据时可从最近的网络提供商的机房获取；方向代理部署在网站的中心机房，当用户请求达到中心机房时，首先访问的服务器是反向代理服务器，如果其中国内缓存着用户请求的资源，就直接返回给用户
7. 使用分布式文件系统和分布式数据库系统：分布式数据库是数据库拆分的最后手段，只有在单表数据规模非常庞大时才使用，常用的的是数据库拆分手段是业务分库，将不同业务的数据库部署在不同的物理服务器上
8. 使用NoSQL和搜索引擎：由于数据存储和检索的需求越来越复杂，需要采用非关系数据库如NoSQL和非数据库查询技术如搜索引擎
9. 业务拆分：将不同的产品线，分归不同的业务团队负责。每个业务应用独立部署，应用之间通过超链接或通过访问同一个数据存储系统建立关系
10. 分布式服务：随着业务越拆分越小，系统存储越来越大，系统整体复杂程度上生，部署维护越来越困难。由于所有应用要和所有数据库系统连接，数据库连接资源不足拒绝服务。既然每个应用系统都要执行很多相同的业务操作（如用户管理、商品管理），可将这些共用的业务提取出来，独立部署，由这些可复用的业务连接数据库，提供共用业务服务，应用程序只需要管理用户界面，通过分布式服务调用共用业务服务。

### 大型网站架构演化的价值观
在网站还很小的时候就去追求架构师舍本逐末、得不偿失的。小型网站最需要的是提供好的服务来创造价值

大型网站架构的核心不是从无到有搭建一个大型网站，而是能报岁小型网站业务的逐步发展，慢慢演化成一个大型网站，不需要放弃什么、推翻什么，不需要剧烈的革命

### 误区
1. 一味追求大公司的解决方案
2. 为了技术而技术：脱离业务发展，一味追求时髦的新技术，可能会让架构之路越走越难
3. 企图用技术解决所有问题：有时真正的问题不是技术架构，而是业务架构。例12306：调整业务需求，在售票上引入了排队机制、整点售票改为分时段售票，控制住了并发访问的量，棘手的技术问题也不是问题了。**技术是用来解决业务问题的，而业务的问题，也可以通过业务的手段去解决**

## 2 大型网站架构模式
模式的关键在于模式的可重复性，问题与场景的可重复性带来解决方案的可重复使用

### 网站架构模式
#### 分层
在横向切分成几个部分，通过上层对下层的依赖和调用组成一个系统

分为应用层（展示）、服务层（为应用层提供服务支持）、数据层（数据库、缓存、文件、搜索引擎等）。应用层还可分为视图层和业务逻辑层，服务层可分为数据接口层和逻辑处理层。禁止跨层次的掉用、逆向调用。在部署上，三层结构分别部署在不同的服务器

在网站还很小的时候就该分层，将来可以更好的应付

#### 分割
在纵向对软件进行切分。将不同的功能和服务包装成高内聚低耦合的模块单元。在应用层（或服务层），将不同的业务分割，由不同的团队负责，不管是在逻辑上还是物理上，都是可以独立的

#### 分布式
分割和分层主要是为了模块便于分布式部署，将不同的模块部署在不同的服务器上，可用更多的机器完成同样的功能，解决高并发。

缺点：分布式调用网络会对性能造成影响；服务器越多，宕机的概率也越大；数据在分布式环境中保持一致性也很难，分布式事务也难以保证；导致网站依赖错综复杂，难以开发维护。因此要量力而行，不要为了分布式而分布式

常用的分布式方案：
1. 分布式应用和服务：将分层和分割后的模块进行分布式部署，可改善性能和并发性、加快开发和发布速度、减少数据库连接消耗、使不同的应用服用共同的服务，便于业务扩展
2. 分布式静态资源：**动静分离**，静态资源独立分布式部署，并采用独立的域名（加快浏览器并发加载的速度），减轻应用服务器的负载压
3. 分布式数据和存储：对传统的关系型数据库、各种NoSQL都进行分布式部署
4. 分布式计算：除了应用、服务、实时数据处理等在线业务外，后台业务的计算规模也非常庞大：搜索引擎的索引构建、数据仓库的数据分析统计等，目前普遍使用Hadoop和MapReduce分布式计算框架进行此类批处理计算，其特点是移动计算而不是移动数据，将计算程序分发到数据所在的位置以加速计算和分布式计算

#### 集群
对于用户集中的模块（例如首页），还需要将独立部署的服务器集群化（多台服务器部署相同应用构成一个集群），通过负载均衡设备共同对外提供服务。更好的并发。当某台服务器发射管你故障，可以转发到其他服务器上，所以即使访问量很小的分布式应用和服务，也应该至少部署两台服务器构成一个集群，提高系统可用性

#### 缓存
- CDN
- 反向代理
- 本地缓存：应用本地缓存
- 分布式缓存：将数据缓存在分布式缓存集群中

#### 异步
在单一服务器可使用多线程共享内存队列的方式实现异步；在分布式系统中，多个服务器集群通过分布式消息队列实现异步。异步架构的典型是生产者消费者模式

特性：
- 提高系统可用性：消费者服务器发生故障时，数据会在消息队列服务器中存储堆积，生产者服务器可以继续处理业务请求，系统整体表现无故障，当消费者恢复后，继续处理消息队列中的数据
- 加快网站响应速度：将请求写入消息队列不需要处理就可返回，响应延迟减少（但是获取不到结果）
- 消除高并发访问高峰：将突然增加的访问请求数据库放入消息队列中，依次处理，就不会对网站负载造成太大压力

可能会对用户体验、业务流程造成影响，需要网站产品设计方面的支持

#### 冗余
想保证服务器宕机依然可以运行，不丢失数据，就需要一定程度的服务器冗余运行，数据冗余备份，当某台服务器宕机，可将其上的服务和数据访问转移到其他机器上

服务器需要定期冷备份，也需要对数据库进行主从分离，实时同步实现热备份

#### 自动化
通过减少人为干预，使发布过程自动化可有效减少发布故障

1. 自动化代码管理：代码版本控制、代码分支创建合并自动化
2. 自动化测试：开发完成提交测试后，系统自动将代码部署到测试环境，启动自动化测试用例进行测试
3. 自动化安全测试：安全检测工具对代码进行静态安全扫描以及部署到安全测试环境进行安全攻击测试，评估其安全性
4. 自动化部署
5. 自动化监控：进行心跳检测，并监控各项性能和关键数据指标
6. 自动化报警：如遇到异常，发送报警信息
7. 自动化失效转移：故障发生后，将失效的服务器从集群中隔离出去
8. 自动化失效恢复，当然故障消除，重新启动服务
9. 自动化降级：当网站遇到高峰，超出最大处理能力，会进行自动化降级，拒绝部分请求及关闭部分不重要的服务将负载降至安全的水平
10. 自动化分配资源：将空闲资源分配给重要的服务，扩大其部署规模

#### 安全

- 通过密码和手机验证码进行身份确认
- 登陆、交易对网络通信进行加密
- 敏感数据加密处理
- 防止机器人滥用网络资源攻击网站，使用验证码进行识别
- 用于攻击网站的XSS攻击、SQL注入，进行编码转换等处理
- 垃圾信息、敏感信息进行过滤
- 对交易转账等重要操作根据交易模式和交易信息进行风险控制

### 架构模式在新浪微博的应用

发微博后将微博写入消息队列后立即返回，响应迅速，消息队列付费者任务将微博推送给所有当前在线粉丝的订阅列表中，非在线用户通过拉取的方式获取

由于刷新频繁，使用多级缓存策略，将热门微博和明星用户的微博缓存在所有微博服务器，在线用户的微博和近期微博缓存在分布式缓存集群中，刷微博几乎都是缓存访问操作

## 3 大型网站核心架构要素
系统的各个重要组成部分及其关系构成了系统的架构，这些组成部分可以是具体的功能模块，也可能是非功能的设计与决策。除了系统功能需求外，软件架构还需要关注性能、可用性、伸缩性、扩展性和安全性

### 性能
- 浏览器端：浏览器缓存、页面压缩、合理布局页面、减少Cookie传输、CDN
- 应用服务器端：缓存、通过异步将请求发送至消息队列等待后续处理、多台应用服务器组成集群
- 代码：多线程、改善内存管理
- 数据库：索引、缓存、SQL优化、NoSQL通过优化数据模型、存储结构、伸缩特性等手段在性能方面也具有优势

### 可用性
网站宕掉、服务不可用是重大事故，影响网站声誉，还可能摊上官司。高可用架构架构设计的前提是必然会出现服务器宕机（硬件故障），高可用设计的目标就是当服务器宕机以及出现各种不可预期的问题时，服务或应用依然可用。

网站高可用主要手段是冗余，应用部署在多台服务器上同时提供访问，数据在多台服务器上互相备份，任何一台服务器宕机都不会导致应用的整体可用，也不会导致数据丢失。

对于因应用服务器，通过负载均衡设备组成一个集群共同提供服务，当一台服务器宕机时，只需把请求切换到其他服务器就可实现应用高可用，但前提是应用服务器上不能保存请求的会话信息，否则宕机后会话丢失，即使转发到其他服务器也无法完成业务处理

对于存储服务器，数据实时备份，宕机时将数据访问转移到可用的服务器，进行数据恢复保证继续有服务器宕机时数据依然可用

### 伸缩性
指通过不断向集群中加入服务器的手段来缓解不断上升的并发压力和数据存储需求。衡量标准是是否可用多台服务器构架集群，增加服务器是否方便，加入后是否可以提供无差别服务，集群中可容纳的总的服务器数量是否有限制

对于应用服务器集群，只要不保存数据，所有服务器都是对等的，通过负载均衡就可以加入服务器

对于缓存服务器集群，加入新的服务器可能导致缓存路由失效，导致大部分缓存数据无法访问，需要改进就缓存路由算法保证缓存数据的可访问性

关系型数据库虽然支持数据复制、主从热备，但是很难做到大规模集群的可伸缩性，因此关系数据库的集群伸缩方案必须在数据库之外实现，通过区分路由等手段将部署有多个数据库的服务器组成一个集群

对于大部分NoSQL，先天就是为海量数据而生的，因此对伸缩性的支持都非常好，可以较少运维的情况下实现伸缩

### 扩展性
网站的扩展性直接关注网站的功能需求，如何设计网站的架构使其能快速响应需求变化，是可扩展架构的主要目的。衡量的标准是在增加新业务时，是否可以对现有产品透明无影响，不需要或只要很少改动就可以上线新产品，不同产品之间少耦合

可扩展架构的主要手段是事件驱动架构和分布式服务
事件驱动架构：使用消息队列实现，可透明底增加新的消息生产者、消费者任务
分布式服务：将业务和可复用服务分开，通过分布式框架调用，新增产品直接调用服务，对现有产品无影响

大型网站为了保持市场地位，会吸引第三方开发者，为他们提供开放平台

### 安全性
针对攻击和窃密，是否有应对策略

## 4 瞬时响应：网站的高性能架构
### 网站性能测试
**性能测试指标**
1. 响应时间。收到响应和发出请求之间的时间差，测试程序也需要花费时间，所以通常采用重复请求（重复一万次，总时间除以一万）
2. 并发数。同时处理的数目。测试程序通过多线程模拟并发用户来测试系统的并发处理能力，并不是不停地发送请求。而是两次请求之间加入一个随机等待时间（称为思考时间）
3. 吞吐量。但是时间内系统处理的请求数量，提现系统的整体处理能力。TPS（每秒事务数）是常用来量化吞吐量的指标，HPS（每秒HTTP请求数）、QPS（每秒查询数）
4. 性能计数器。描述服务器或系统性能的一些数据指标，也是系统监测的重要指标。System Load、对象与线程数、内存使用、CPU使用、硬盘与网络I/O等
    System Load：系统负载，正在和等待被CPU执行的进程数目总和，反应系统忙闲程度，Load的理想值是CPU数量。高于CPU时表示进程在排队等待CPU调度，系统资源不足
    
**性能测试的方法**
性能测试
负载测试
压力测试
稳定性测试

### Web前端性能优化
**浏览器访问优化**
1. 较少http请求，每次http请求都要建立通信链路，服务器端每个http请求都需要启动独立的线程处理。主要手段是合并CSS、合并JavaScript、合并图片
2. 使用浏览器缓存。使用缓存的网站在更新静态资源时，如果要即时更新，可修改资源文件名；更新多个文件应该逐量更新，有一定的时间间隔，以免用户集中更新缓存，造成服务器负载骤增
3. 启用压缩，文本文件的压缩率可达到80%以上，HTML、CSS、JavaScript启用GZip压缩，但是压缩会对服务器和浏览器产生一定压力（在通信良好，服务器资源不足的情况下就不要压缩了）
4. CSS放在页面最上面、JS放在最下面。浏览器会在下载完CSS后才对页面渲染，JS在加载后立刻执行，可能会阻塞页面，所以放在最下面（页面解析的JS例外）
5. 减少Cookie传输。大量Cookie严重影响数据传输，尽量减少Cookie中传输的数据量，对于静态资源发送Cookie没有意意义，将静态资源放在独立域名，避免这种情况

**CDN**
**反向代理**

### 应用服务器性能优化
#### 布式缓存
缓存的本质是一个内存Hash表。缓存遵循二八定律，80%的访问落在20%的数据上（大部分数据访问集中在小部分数据上），只缓存这20%的数据

**缓存滥用**
- 频繁修改的数据：会出现写入缓存后，还来不及读取缓存，数据就已失效，一般数据的读写比在2:1（写入一次缓存，在更新前至少读取两次）以上，缓存才有意义
- 没有热点的访问：内存资源宝贵，只能将最新访问的数据缓存起来，历史数据清除，如果数据没有热点，不遵循二八定律，缓存就没有意义
- 数据不一致与脏读：缓存要容忍一定时间的数据不一致（有失效时间）。可以数据更新时立即更新缓存，但是会带来更多系统开销和事务一致性的问题
- 缓存可用性：缓存数据丢失或不可用不会影响到应用程序的处理
- **缓存预热：最好在缓存系统启动时就把热点数据加载好，例如一些元数据（城市地名列表、类目信息）**
- **缓存穿透：因为不恰当的业务或恶意攻击持续高并发地请求某个不存在的数据，对数据库造成很大压力，一个简单的对策是将不存在的数据也缓存起来（值为null）**

#### 异步操作
